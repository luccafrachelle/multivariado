---
title: "Entrega Final - Multivariado"
author: "Lucca Frachelle, Joaquín Silva, Cecilia Waksman"
format: pdf
editor: visual
---

# Resumen Ejecutivo

Los datos utilizados en este análisis surgen de un estudio epidemiológico llevado a cabo en la Facultad de Odontología de la Universidad de la República, Uruguay, durante el período 2015-2016. Los mismos son recogidos de 602 individuos que acudieron a consulta. Este análisis se centra mayormente en el uso de variables binarias para identificar la presencia de enfermedades no transmisibles (ENT) y otros factores de riesgo asociados con la salud bucal, tratados aquí como comorbilidades. Los atributos estudiados se agrupan en tres bloques principales: comportamentales, ENT generales, y patologías odontológicas específicas, además se cuenta con variables demográficas diversas (edad, ingreso, sexo, nivel educativo). Entre los comportamentales se incluyen el consumo diario de tabaco, el consumo nocivo de alcohol y la insuficiencia de actividad física. Los ENT se refieren a condiciones como sobrepeso/obesidad, razón de cintura-cadera, hipertensión y diabetes. Finalmente, las condiciones odontológicas incluyen la prevalencia de bolsas periodontales, pérdida dentaria, caries y prevalencia de patología periapical infecciosa (PIP).

![](./variables.png)

Además contamos con las variables C, P, O y CPO, donde C es la cantidad de dientes con caries, P es la cantidad de dientes perdidos debido a caries y O la cantidad de dientes con caries obturadas, además CPO es la suma de las tres anteriores.

El estudio empleó técnicas de muestreo sistemático para seleccionar una muestra representativa, ajustada para medir prevalencias de hasta un 25% con un margen de error de 0.05 y un nivel de confianza del 95%. Se aplicaron cuestionarios sociodemográficos y exámenes bucodentales completos, evaluando la salud dental y de la mucosa, además de medidas antropométricas y análisis de presión arterial y glucemia.

# Introducción

En el presente trabajo, aprovechamos un conjunto de datos derivados de individuos que solicitaron atención en la Facultad de Odontología de la Universidad de la República, Uruguay, entre 2015 y 2016, para realizar un estudio exploratorio que indaga cómo los factores de riesgo comportamentales y las enfermedades no transmisibles (ENT) influyen en las patologías odontológicas. A través del uso de métodos de clasificación tanto supervisada, Análisis de Discriminantes, como no supervisada, Clustering, buscamos comprender las interacciones y posibles correlaciones entre estos distintos aspectos de la salud.

Este trabajo se centra en analizar las asociaciones entre variables, con el fin de identificar patrones que sugieran cómo los hábitos de vida y las condiciones de salud impactan en la salud bucal.

Así, nuestro análisis no solo ayuda a esclarecer la estructura de los datos y la relación entre diversas condiciones de salud, sino que también facilita el entendimiento de los factores de riesgo que afectan en la salud bucal.

# Marco metodológico

## Clustering

Este es un método de clasificación no supervisada que, aplicado a una base de datos, consiste en dividir la misma en subgrupoC/clusters de observaciones mediante un orden determinado. Dicho orden toma en cuenta cierta distancia (a definir, depende del tipo de clustering a usar y de la estructura de los datos) entre subgrupoC y/o observaciones, según los valores que tomen las variables de dicha base.

**Clusters jerárquicos:**

Los clusters de tipo jerárquico se entienden como particiones encajadas que deben seguir cierta jerarquía basada para la aglomeración o separación de los subconjuntos. Gracias a ello los mismos permiten seguir claramente la historia de construcción de cada grupo. Existen dos tipos de clusters jerárquicos:

-   **Divisivos**: Comienza tomando como grupo a todo el conjunto de individuos, los cuales irá separando en subgrupoC en las siguientes etapas hasta obtener tantos clusters como observaciones.

-   **Agregativo**: Cada individuo comienza siendo un cluster unitario que se une con otros en las etapas siguientes hasta formarse un único cluster que cuenta con todos los individuos.

En nuestro análisis usaremos únicamente los de tipo agregativo.

En este tipo de clustering, la distancia a utilizar es seleccionada según las características de las variables en cuestión, así como también la relación entre las mismas. En nuestro caso, como contamos con variables tanto numéricas como categóricas, es necesario usar la distancia de Gower.

La **distancia de Gower** se calcula de distinta manera según el tipo de variable, pero siempre los valores obtenidos se encuentran entre 0 y 1, lo que permite que estas distancias sean comparables.

... completar

**Clusters no jerárquicos:**

Para el análisis usaremos unicamente los clusters no jerárquicos por el método de **K-means**. Este consiste en seleccionas K centros provisorios, los cuales inducen una partición del conjunto de individuos en k subgrupoC. Luego, se vuelven a seleccionar nuevos centros de gravedad, en base a las distancias de los individuos del grupo a los centros. Esta nueva partición cuenta con una reducción de la variabilidad intragrupo. Este proceso se repite siempre y cuando las particiones en etapas sucesivas sean diferentes o hasta que se alcanza un número de iteraciones determinado.

**Análisis Discriminante**

completar...

```{r}
#| output: false
library(tidyverse)
library(cluster)
library(NbClust)
library(factoextra)
library(knitr)
library(gridExtra)
```

\newpage

# Carga de datos y limpieza

```{r}
load('./data/bfm.RData')
```

Originalmente se cargan 4 dataframes : D, datos , DATOS y dato01.601, de los cuales solo utilizaremos datos.

```{r}
datos = datos %>% select(-c(17:22 , 28)) %>% filter(!if_any(c(1:23), is.na))
datos = datos %>% select(-c(16, 22, 23))
```

# Clasificasión no supervisada

## Cluster Jerárquico

```{r, message=FALSE}
DG<-daisy(datos,metric = "gower")
fviz_dist(DG, lab_size = 3)
```

...decir algo del gráfico o sacar

**Método de Ward**

Se utiliza el método de Ward para formar los clusters, los cuales se van agrupando en cada etapa de la forma en que se muestra en el siguiente dendograma.

```{r}
W.DG<-agnes(DG, diss=TRUE,method = "ward")
fviz_dend(W.DG)
```

Para elegir la cantidad de clusters, se recurre a los índices: *Cindex*, *Silouhette*, *Mcclain*, *Dunn* y *Frey*.

```{r, message=FALSE}
cindexW <- NbClust(data=NULL, diss=DG, distance=NULL, method="ward.D", index="cindex")[[2]][1]
silW <- NbClust(data=NULL, diss=DG, distance=NULL, method="ward.D", index="silhouette")[[2]][1]
mcclainW <- NbClust(data=NULL, diss=DG, distance=NULL, method="ward.D", index="mcclain")[[2]][1]
dunnW <- NbClust(data=NULL, diss=DG, distance=NULL, method="ward.D", index="dunn")[[2]][1]
freyW <- NbClust(data=NULL, diss=DG, distance=NULL, method="ward.D", index="frey")[[2]][1]

nro_clustersW <- as.data.frame(t(c(cindexW, silW, mcclainW, dunnW, freyW)))
colnames(nro_clustersW) <- c("Cindex", "Silohuette", "Mcclain", "Dunn", "Frey")
rownames(nro_clustersW) <- c("Ward")
kable(nro_clustersW)
```

Como la mayoría de ellos plantean 2 como la cantidad aconsejable, se continuará el análisis para clusters jerárquicos en función de esta división.

```{r}
siluetaW<-silhouette(cutree(W.DG , 2) , DG)
fviz_silhouette(siluetaW)
```

...completar (son 2 salidas, tabla y gráfico)

```{r}
datos$grupoW<-cutree(W.DG , 2)
datos$grupoW<-as.factor(datos$grupoW)
## edad
a <- datos %>% ggplot() + geom_boxplot(aes(x = grupoW, y = edad, fill = factor(grupoW))) + labs(title = "Edad por cluster", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")
### respecto a cpo y edad
b <- datos %>% ggplot() + geom_point(aes(x = edad, y = CPO, color = factor(grupoW))) + labs(title = "Edad vs CPO por cluster", color="Cluster")
grid.arrange(a,b, ncol=2)
```

Los clusters parecen estar divididos entre quienes son menores y mayores a 47 años. También se observa que aquéllos mayores a esta edad, son los que presentan un CPO en general más alto.

```{r}
## cluster por niveledrec
datos %>% ggplot() + geom_bar(aes(x = grupoW, fill = factor(grupoW))) + facet_wrap(~niveledu) + labs(title = "Distribución de clusters por nivel educativo", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")
#No dice nada, quito?
```

```{r}
### por ingreso
datos %>% ggplot() + geom_bar(aes(x = grupoW, fill = factor(grupoW))) + facet_wrap(~ingresos) + labs(title = "Distribución de clusters por ingresos", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")
#No dice nada, quito?
```

```{r}
c <- datos %>% ggplot() + geom_bar(aes(x = grupoW, fill = factor(grupoW))) + facet_wrap(~V8) + labs(title = "Clusters por prevalencia de bolsa", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")
d <- datos %>% ggplot() + geom_bar(aes(x = grupoW, fill = factor(grupoW))) + facet_wrap(~V9) + labs(title = "Clusters por perdida dentaria", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")
e <- datos %>% ggplot() + geom_bar(aes(x = grupoW, fill = factor(grupoW))) + facet_wrap(~V10) + labs(title = "Clusters por prevalencia de caries", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")
f <- datos %>% ggplot() + geom_bar(aes(x = grupoW, fill = factor(grupoW))) + facet_wrap(~V10) + labs(title = "Clusters por prevalencia de PIP", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")

grid.arrange(c,d,e,f, ncol=2)
```

La diferencia más notoria se observa en la pérdida dentaria, donde el primer grupo, aquellas personas más mayores, en su mayoría no presenta pérdida dentaria, mientras que el segundo grupo, aquéllos más jóvenes, cuentan con una frecuencia alta de la misma variable. Las demás variables no parecen mostrar diferencias significativas entre las categorías según el grupo.

**Método del vecino más lejano**

```{r, message=FALSE}
cindexC <- NbClust(data=NULL, diss=DG, distance=NULL, method="complete", index="cindex")[[2]][1]
silC <- NbClust(data=NULL, diss=DG, distance=NULL, method="complete", index="silhouette")[[2]][1]
mcclainC <- NbClust(data=NULL, diss=DG, distance=NULL, method="complete", index="mcclain")[[2]][1]
dunnC <- NbClust(data=NULL, diss=DG, distance=NULL, method="complete", index="dunn")[[2]][1]
freyC <- NbClust(data=NULL, diss=DG, distance=NULL, method="complete", index="frey")[[2]][1]

nro_clustersC <- as.data.frame(t(c(cindexC, silC, mcclainC, dunnC, freyC)))
colnames(nro_clustersC) <- c("Cindex", "Silohuette", "Mcclain", "Dunn", "Frey")
rownames(nro_clustersC) <- c("Complete")
kable(nro_clustersC)
```

```{r}
C.DG<-agnes(DG, diss=TRUE,method = "complete")
fviz_dend(C.DG)
```

```{r}
siluetaC<-silhouette(cutree(C.DG , 2) , DG)
fviz_silhouette(siluetaC)
```

```{r}
datos$grupoC<-cutree(C.DG , 2)
datos$grupoC<-as.factor(datos$grupoC)

A <- datos %>% ggplot() + geom_bar(aes(x = grupoC, fill = factor(grupoC))) + labs(title = "Distribución de clusters", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")
## edad
B <- datos %>% ggplot() + geom_boxplot(aes(x = grupoC, y = edad, fill = factor(grupoC))) + labs(title = "Edad por cluster", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")

grid.arrange(A,B,ncol=2)
```

```{r}
## cluster por niveledrec
datos %>% ggplot() + geom_bar(aes(x = grupoC, fill = factor(grupoC))) + facet_wrap(~niveledu) + labs(title = "Distribución de clusters por nivel educativo", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")
```

```{r}
# Por ingreso
datos %>% ggplot() + geom_bar(aes(x = grupoC, fill = factor(grupoC))) + facet_wrap(~ingresos) + labs(title = "Distribución de clusters por ingresos", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")
```

```{r}
### respecto a cpo y edad
datos %>% ggplot() + geom_point(aes(x = edad, y = CPO, color = factor(grupoC))) + labs(title = "Edad vs CPO por cluster", color="Cluster")
```

```{r}
par(mfrow=c(2,2))
datos %>% ggplot() + geom_bar(aes(x = grupoC, fill = factor(grupoC))) + facet_wrap(~V8) + labs(title = "Distribución de clusters por prevalencia de bolsa", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")
datos %>% ggplot() + geom_bar(aes(x = grupoC, fill = factor(grupoC))) + facet_wrap(~V9) + labs(title = "Distribución de clusters por perdida dentaria", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")
datos %>% ggplot() + geom_bar(aes(x = grupoC, fill = factor(grupoC))) + facet_wrap(~V10) + labs(title = "Distribución de clusters por prevalencia de caries", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")
datos %>% ggplot() + geom_bar(aes(x = grupoC, fill = factor(grupoC))) + facet_wrap(~V10) + labs(title = "Distribución de clusters por prevalencia de PIP", fill="Cluster")+ylab("Frecuencia")+xlab("Cluster")
```

## Cluster No Jerárquico

## Cluster No Jerárquico

```{r}
df_dummy <- model.matrix(~ . - 1, data = datos)

df_scaled <- scale(df_dummy)
```

```{r}
fviz_nbclust(df_scaled, kmeans, method = "wss") +
  labs(subtitle = "Codo")
```

```{r}
fviz_nbclust(df_scaled, kmeans, method = "silhouette") +
  labs(subtitle = "Silueta")
```

Dada la información obtenida de los gráficos de codo y silueta, se procede a realizar un análisis de cluster con 4 grupos. Ya que el gráfico de codo no presenta un punto de inflexión claro se opta por un punto medio entre silueta y codo.

```{r}
set.seed(123456)
kmeans5 <- kmeans(df_scaled, 4, iter.max = 10000)
datos = datos %>% mutate(cluster = kmeans5$cluster)
datos = datos %>% mutate(cluster = as.factor(cluster))
```

### Análisis entre clusters

```{r}
datos %>% ggplot() + geom_bar(aes(x = cluster, fill = cluster)) + labs(title = "Distribución de clusters")
```

La distribución de personas entre los clusters es bastante homogénea. No hay un cluster que se destaque por tener una cantidad de personas mucho mayor que los otros.

```{r}
datos %>% ggplot() + geom_bar(aes(x = cluster, fill = cluster)) + facet_wrap(~niveledu) + labs(title = "Distribución de clusters por nivel educativo")
```

El cluster 4 es el que tiene la mayor cantidad de personas con nivel educativo bajo. La mayoría de las personas en este cluster tienen un nivel educativo que varía entre ciclo básico y primaria incompleta.

Los otros clusters tienen una distribución más homogénea entre los distintos niveles educativos.

```{r}
datos %>% ggplot() + geom_bar(aes(x = cluster, fill = cluster)) + facet_wrap(~ingresos) + labs(title = "Distribución de clusters por ingresos")

```

Parece que los ingresos no están influyendo en la variabilidad entre los clusters.

```{r}
datos %>% ggplot() + geom_boxplot(aes(x = cluster, y = edad, fill = cluster)) + labs(title = "Edad por cluster")


```

Se identifican dos clusters claramente diferenciados por edad: el cluster 2, con una mediana de 25 años, y el cluster 4, con una mediana de 60 años. En contraste, los clusters 1 y 3 tienen edades similares, con una mediana de alrededor de 50 años, y presentan la mayor variabilidad en sus distribuciones de edad

```{r}
datos %>% ggplot() + geom_point(aes(x = edad, y = CPO, color = cluster)) + labs(title = "Edad vs CPO por cluster")
```

Se observa una correlación positivia entre la edad y el CPO. El cluster 4 es el que tiene tanto el CPO más alto como la mayor edad. Por otro lado, se nota una diferencia entre el cluster 1 y el cluster 3 respecto al CPO. Aunque tienen edades similares, con una mediana de alrededor de 50 años, el cluster 3 presenta un CPO mayor. El cluster 1, en cambio, está por debajo tanto en CPO como en edad.

## Analisis probelmas odontologicos

```{r}
datos %>% ggplot() + geom_bar(aes(x = cluster, fill = cluster)) + facet_wrap(~V8) + labs(title = "Distribución de clusters por prevalencia de bolsa")
```

No hay una gran diferencia entre los clusters en cuanto a la prevalencia de bolsa.

```{r}
datos %>% ggplot() + geom_bar(aes(x = cluster, fill = cluster)) + facet_wrap(~V9) + labs(title = "Distribución de clusters por perdida dentaria")
```

Llama la atención lo bien que los clusters se discriminan en función de la pérdida dentaria. Por un lado, el cluster 4 está compuesto completamente por personas que no poseen pérdida dentaria, mientras que los clusters 2 y 3 pertenecen en su gran mayoría a personas que tienen pérdida dentaria. El cluster 1, sin embargo, no parece estar tan bien explicado por la pérdida dentaria.

```{r}

datos %>% ggplot() + geom_bar(aes(x = cluster, fill = factor(cluster))) + facet_wrap(~V11) + labs(title = "Distribución de clusters por prevalencia de PIP")

```

Un poco vinculando con lo visto en el PCA, se observa que el cluster más joven es el cluster 2, el cual tiene la menor prevalencia de PIP. En contraste, el cluster 4 tiene la mayor edad y la mayor prevalencia de PIP. Además, se observa que los clusters 1 y 3 tienen una prevalencia de PIP similar.

## Respecto a variables de salud

```{r}
datos %>% ggplot() + geom_bar(aes(x = cluster, fill = cluster)) + facet_wrap(~V1) + labs(title = "Distribución de clusters por si fuma")
```

Aqui se observa una diferencia clara entre los cluster que eran mas parecidos. Queda por un lado el cluster 1 en su mayoria fumadores y por otro lado el cluster 3 en su mayoria no fumadores. El cluster 4 por su parte también queda bien diferenciado , la mayoria se encunetran en personas que no fuman.

```{r}
datos %>% ggplot() + geom_bar(aes(x = cluster, fill = cluster)) + facet_wrap(~V4) + labs(title = "Distribución de clusters por peso")
```

En este caso se tiene que el cluster 3 y 4 queda en su mayoria en personas con sobrepeso. Mientras que el cluster 2 queda en su mayoria en personas con peso normal. El cluster 1 queda en su mayoria en personas con bajo peso.

### Cluster 2

-   **Edad:** Las personas más jóvenes.

-   **CPO:** Bajo.

-   **Pérdida Dentaria:** Presenta pérdida dentaria.

-   **Prevalencia de PIP:** Mayormente no tiene prevalencia de PIP.

-   **Fumar:** La mayoría no fuma.

### Cluster 4

-   **Edad:** Las edades más altas.

-   **CPO:** Los CPO más altos.

-   **Pérdida Dentaria:** No tienen pérdida dentaria.

-   **Prevalencia de PIP:** Tienen prevalencia de PIP.

-   **Fumar:** La mayoría no fuma.

### Cluster 1

-   **Edad:** Similar al cluster 3.

-   **CPO:** Un poco mayor que el cluster 3.

-   **Pérdida Dentaria:** No está bien explicado por la pérdida dentaria.

-   **Prevalencia de PIP:** Prevalencia de PIP un poco alta.

-   **Fumar:** La mayoría fuma.

### Cluster 3

-   **Edad:** Similar al cluster 1.

-   **CPO:** Un poco menor que el cluster 1.

-   **Pérdida Dentaria:** Presenta pérdida dentaria.

-   **Prevalencia de PIP:** Prevalencia de PIP un poco alta.

-   **Fumar:** La mayoría no fuma.

-   **Peso:** La mayoría tiene sobrepeso


# Análisis supervisado

## Análisis de discriminante logistico

Teniendo en cuenta que la prevalencia de pip(V11) es un factor importante de riesgo odnologico se procede a realizar un analisis de discriminante logistico. Para intentar predecir la prevalencia de pip en base a las otras variables.

```{r}
library(caret)
library(pROC)
trainIndex <- createDataPartition(datos$V11, p = 0.7, list = FALSE)
trainData <- datos[trainIndex, ]
testData <- datos[-trainIndex, ]
```

```{r}
modelo_logistico <- glm(V11 ~ ., data = trainData, family = binomial)
```

el summary es re largo

```{r}
predicciones <- predict(modelo_logistico, newdata = testData, type = "response")
roc_obj <- roc(testData$V11, predicciones)
plot(roc_obj, col = "blue")

```

```{r}
best_threshold <- coords(roc_obj, "best", ret = "threshold")
best_threshold = as.numeric(best_threshold)
best_threshold

```

```{r}

predicciones <- predict(modelo_logistico, newdata = testData, type = "response")

predicciones_clase <- ifelse(predicciones > best_threshold, 1, 0)
predicciones_clase <- ifelse(predicciones_clase == 1, "si", "no") %>% factor(levels = c("si", "no"))


conf_matrix <- confusionMatrix(predicciones_clase, testData$V11)
conf_matrix

```
